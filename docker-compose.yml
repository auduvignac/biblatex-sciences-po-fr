# docker-compose.yml

services:
  latex:
    # Utilise l'image construite à partir du Dockerfile
    build: .
    
    # Nom du conteneur pour faciliter les commandes manuelles
    container_name: latex_compiler

    # TEXMFHOME pointe vers un arbre TeX local où l'on monte le style biblatex
    environment:
      TEXMFHOME: /app/texmf
    
    # Crée le répertoire de sortie puis lance la compilation
    command: >
      bash -lc "
        mkdir -p /app/build &&
        latexmk -pdf -xelatex main.tex &&
        cp /app/build/main.pdf /app/main.pdf &&
        chown ${UID:-1000}:${GID:-1000} /app/main.pdf
      "

    # Montage de volume:
    volumes:
      # Sources LaTeX minimales
      - ./main.tex:/app/main.tex:ro
      - ./latexmkrc:/app/latexmkrc:ro
      - ./bibliographies:/app/bibliographies:ro

      # Sorties et fichiers auxiliaires (volume nommé, pas de dossier créé sur l'hôte)
      - build-cache:/app/build

      # PDF exporté directement à la racine du projet
      - ./main.pdf:/app/main.pdf

      # Style biblatex SciencesPo directement visible par LaTeX/Biber
      - ./style/sciencespo.cbx:/app/texmf/tex/latex/biblatex/cbx/sciencespo.cbx:ro
      - ./style/sciencespo.bbx:/app/texmf/tex/latex/biblatex/bbx/sciencespo.bbx:ro
      - ./biblatex-dm.cfg:/app/texmf/tex/latex/biblatex/biblatex-dm.cfg:ro

volumes:
  build-cache:
